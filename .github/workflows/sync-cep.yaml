---
name: Sync CEP

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      scope:
        description: What to sync
        type: choice
        options:
          - all
          - skills
          - agents
          - commands
        default: all
      dry_run:
        description: Preview changes without creating PR
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: sync-cep
  cancel-in-progress: false

jobs:
  precheck:
    name: CEP Pre-check
    runs-on: ubuntu-latest
    outputs:
      exit_code: ${{ steps.precheck.outputs.exit_code }}
      summary: ${{ steps.precheck.outputs.summary }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.FRO_BOT_PAT }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run pre-check
        id: precheck
        run: |
          set +e
          bun scripts/check-cep-upstream.ts > precheck.json
          exit_code=$?
          summary='{}'
          if [ -s precheck.json ]; then
            summary=$(jq -c '.' < precheck.json 2>/dev/null || echo '{}')
          fi
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
          echo "summary=$summary" >> "$GITHUB_OUTPUT"
          jq -c '{hashChanges, newUpstream, deletions, skipped, converterVersionChanged, errors}' < precheck.json 2>/dev/null || cat precheck.json
          if [ "$exit_code" -eq 2 ]; then
            exit 2
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.FRO_BOT_PAT }}

      - name: Report precheck errors
        if: failure() && steps.precheck.outputs.exit_code == '2'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.FRO_BOT_PAT }}
          script: |
            const summary = JSON.parse(process.env.PRECHECK_SUMMARY || '{}');
            const errors = summary.errors || [];
            const errorList = errors.map(e => `- ${e}`).join('\n');
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const body = [
              '## Pre-check Errors',
              '',
              `Pre-check failed with exit code 2. Found ${errors.length} error(s).`,
              '',
              '### Errors',
              errorList || '_None_',
              '',
              `**Hash changes:** ${(summary.hashChanges || []).length}`,
              `**New upstream:** ${(summary.newUpstream || []).length}`,
              `**Deletions:** ${(summary.deletions || []).length}`,
              '',
              `[Workflow run](${runUrl})`
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'sync-cep',
              state: 'open'
            });

            if (issues[0]) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'sync-cep: precheck errors',
                labels: ['sync-cep'],
                body
              });
            }
        env:
          PRECHECK_SUMMARY: ${{ steps.precheck.outputs.summary }}

  sync:
    name: CEP Sync
    runs-on: ubuntu-latest
    needs: precheck
    if: "!cancelled() && needs.precheck.outputs.exit_code != '' && needs.precheck.outputs.exit_code != '0'"
    permissions:
      contents: read
    env:
      SYNC_PROMPT: |
        /sync-cep ${{ inputs.scope || 'all' }} ${{ inputs.dry_run && '--dry-run' || '' }}

        <precheck-exit-code>${{ needs.precheck.outputs.exit_code }}</precheck-exit-code>

        <precheck-summary>
        ${{ needs.precheck.outputs.summary }}
        </precheck-summary>

        Note: headless CI run â€” user will not see live output.
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.FRO_BOT_PAT }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run build checks
        run: |
          bun run build
          bun run typecheck
          bun run lint
          bun test

      - name: Run Sync Bot
        uses: fro-bot/agent@592ed6a42e597ba0a3a4d9e96fa20a93b0f1bcf1 # v0.26.4
        env:
          OPENCODE_PROMPT_ARTIFACT: 'true'
        with:
          auth-json: '{}'
          github-token: ${{ secrets.FRO_BOT_PAT }}
          prompt: ${{ env.SYNC_PROMPT }}
